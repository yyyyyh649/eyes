<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœŸå®æ„Ÿè¿‘è§†ä¸æ•£å…‰æ¨¡æ‹Ÿå™¨</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #1a1a1a;
            color: white;
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* é¦–é¡µæ ·å¼ */
        .intro-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            text-align: center;
        }
        .logo { font-size: 60px; margin-bottom: 20px; }
        h1 { font-size: 2.5em; margin-bottom: 15px; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .subtitle { font-size: 1.2em; opacity: 0.8; margin-bottom: 40px; max-width: 600px; line-height: 1.6; }
        
        .mode-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin-bottom: 40px;
        }
        .mode-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 20px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .mode-card:hover {
            transform: translateY(-5px);
            background: rgba(255,255,255,0.2);
        }
        .mode-card .icon { font-size: 40px; margin-bottom: 15px; }
        .mode-card h3 { margin-bottom: 10px; }
        .mode-card p { font-size: 0.9em; opacity: 0.7; }

        /* æ¨¡æ‹Ÿå™¨é¡µé¢ */
        .viewer-page {
            display: none;
            flex-direction: column;
            height: 100vh;
        }
        .viewer-page.active { display: flex; }
        
        .top-bar {
            background: #252525;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }
        .back-btn {
            background: #444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .back-btn:hover { background: #555; }
        
        .canvas-wrapper {
            flex: 1;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }
        canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        /* æ§åˆ¶é¢æ¿ */
        .controls {
            background: #252525;
            padding: 20px;
            border-top: 1px solid #333;
        }
        .control-row {
            display: flex;
            gap: 40px;
            max-width: 1000px;
            margin: 0 auto;
            align-items: flex-start;
        }
        .control-group { flex: 1; }
        .control-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 14px;
            color: #ccc;
        }
        .value-display {
            font-family: monospace;
            background: #333;
            padding: 2px 6px;
            border-radius: 4px;
            color: #4facfe;
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            background: #444;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #4facfe;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.1s;
        }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.2); }
        
        .ticks {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 12px;
            color: #666;
        }
        
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        .toggle-switch input { display: none; }
        .slider-track {
            width: 40px;
            height: 20px;
            background: #444;
            border-radius: 20px;
            position: relative;
            transition: 0.3s;
        }
        .slider-track::before {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: 0.3s;
        }
        input:checked + .slider-track { background: #4facfe; }
        input:checked + .slider-track::before { transform: translateX(20px); }

        #fileInput, #video, #uploadedImg { display: none; }
        
        @media (max-width: 768px) {
            .mode-selector { grid-template-columns: 1fr; }
            .control-row { flex-direction: column; gap: 20px; }
            h1 { font-size: 1.8em; }
        }
    </style>
</head>
<body>

    <div id="introPage" class="intro-page">
        <div class="logo">ğŸ‘ï¸</div>
        <h1>çœŸå®æ„Ÿè§†åŠ›æ¨¡æ‹Ÿå™¨</h1>
        <p class="subtitle">åŸºäºé«˜æ–¯æ¨¡ç³Šä¸å¤šé‡å åŠ æ¸²æŸ“ç®—æ³•<br>è¿˜åŸçœŸå®çš„è¿‘è§†ä¸æ•£å…‰è§†è§‰ä½“éªŒ</p>
        
        <div class="mode-selector">
            <div class="mode-card" onclick="startCamera()">
                <div class="icon">ğŸ“·</div>
                <h3>å¼€å¯æ‘„åƒå¤´</h3>
                <p>å®æ—¶æ¨¡æ‹Ÿå‘¨å›´ç¯å¢ƒ</p>
            </div>
            <div class="mode-card" onclick="document.getElementById('fileInput').click()">
                <div class="icon">ğŸ–¼ï¸</div>
                <h3>ä¸Šä¼ å›¾ç‰‡</h3>
                <p>ä½¿ç”¨ç…§ç‰‡è¿›è¡Œæµ‹è¯•</p>
            </div>
        </div>
    </div>

    <div id="viewerPage" class="viewer-page">
        <div class="top-bar">
            <button class="back-btn" onclick="goHome()">â† è¿”å›</button>
            <label class="toggle-switch">
                <input type="checkbox" id="splitView" onchange="requestUpdate()">
                <div class="slider-track"></div>
                <span>å¯¹æ¯”æ¨¡å¼ (å·¦ä¾§æ­£å¸¸/å³ä¾§æ¨¡æ‹Ÿ)</span>
            </label>
        </div>
        
        <div class="canvas-wrapper">
            <canvas id="canvas"></canvas>
        </div>
        
        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <div class="control-header">
                        <span>è¿‘è§†åº¦æ•° (Myopia)</span>
                        <span id="myopiaVal" class="value-display">0Â°</span>
                    </div>
                    <input type="range" id="myopiaRange" min="0" max="1000" step="25" value="0" oninput="updateLabels(); requestUpdate();">
                    <div class="ticks">
                        <span>0Â°</span>
                        <span>300Â°</span>
                        <span>600Â°</span>
                        <span>1000Â°</span>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-header">
                        <span>æ•£å…‰åº¦æ•° (Astigmatism)</span>
                        <span id="astigmatismVal" class="value-display">0Â°</span>
                    </div>
                    <input type="range" id="astigmatismRange" min="0" max="600" step="25" value="0" oninput="updateLabels(); requestUpdate();">
                    <div class="ticks">
                        <span>0Â°</span>
                        <span>200Â°</span>
                        <span>400Â°</span>
                        <span>600Â°</span>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-header">
                        <span>æ•£å…‰è½´å‘ (Axis)</span>
                        <span id="axisVal" class="value-display">0Â°</span>
                    </div>
                    <input type="range" id="axisRange" min="0" max="180" step="1" value="0" oninput="updateLabels(); requestUpdate();">
                    <div class="ticks">
                        <span>0Â°</span>
                        <span>90Â°</span>
                        <span>180Â°</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept="image/*" onchange="handleFile(event)">
    <video id="video" autoplay playsinline></video>
    <img id="uploadedImg">

    <script>
        let mode = null; // 'camera' or 'image'
        let stream = null;
        let sourceEl = null;
        let animFrame = null;
        let lastCanvasSize = { w: 0, h: 0 }; // ç¼“å­˜ç”»å¸ƒå°ºå¯¸é¿å…é‡å¤è®¾ç½®
        let updatePending = false; // é˜²æ­¢é‡å¤è¯·æ±‚æ›´æ–°
        
        // ç¼“å­˜DOMå…ƒç´ å¼•ç”¨ï¼Œé¿å…é‡å¤æŸ¥è¯¢
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { alpha: false, willReadFrequently: false }); // ä¼˜åŒ–æ€§èƒ½
        const videoEl = document.getElementById('video');
        const uploadedImgEl = document.getElementById('uploadedImg');
        const myopiaRangeEl = document.getElementById('myopiaRange');
        const astigmatismRangeEl = document.getElementById('astigmatismRange');
        const axisRangeEl = document.getElementById('axisRange');
        const splitViewEl = document.getElementById('splitView');
        const myopiaValEl = document.getElementById('myopiaVal');
        const astigmatismValEl = document.getElementById('astigmatismVal');
        const axisValEl = document.getElementById('axisVal');
        const introPageEl = document.getElementById('introPage');
        const viewerPageEl = document.getElementById('viewerPage');
        
        // åˆå§‹åŒ–
        function init() {
            updateLabels();
            // ä½¿ç”¨é˜²æŠ–çš„resizeå¤„ç†
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    if(mode === 'image') requestUpdate();
                }, 100);
            });
        }
        
        // å¯åŠ¨æ‘„åƒå¤´
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                videoEl.srcObject = stream;
                sourceEl = videoEl;
                mode = 'camera';
                lastCanvasSize = { w: 0, h: 0 }; // é‡ç½®ç¼“å­˜
                switchPage('viewer');
                loop();
            } catch (e) {
                alert('æ— æ³•è®¿é—®æ‘„åƒå¤´: ' + e.message);
            }
        }
        
        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                uploadedImgEl.onload = () => {
                    sourceEl = uploadedImgEl;
                    mode = 'image';
                    lastCanvasSize = { w: 0, h: 0 }; // é‡ç½®ç¼“å­˜
                    switchPage('viewer');
                    requestUpdate();
                };
                uploadedImgEl.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // é¡µé¢åˆ‡æ¢
        function switchPage(pageName) {
            introPageEl.style.display = pageName === 'intro' ? 'flex' : 'none';
            viewerPageEl.classList.toggle('active', pageName === 'viewer');
        }
        
        function goHome() {
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
                stream = null;
            }
            if (animFrame) cancelAnimationFrame(animFrame);
            switchPage('intro');
            
            // é‡ç½®å‚æ•°
            myopiaRangeEl.value = 0;
            astigmatismRangeEl.value = 0;
            axisRangeEl.value = 0;
            updateLabels();
        }

        function updateLabels() {
            myopiaValEl.textContent = myopiaRangeEl.value + 'Â°';
            astigmatismValEl.textContent = astigmatismRangeEl.value + 'Â°';
            axisValEl.textContent = axisRangeEl.value + 'Â°';
        }

        // æ ¸å¿ƒæ¸²æŸ“å¾ªç¯
        function loop() {
            if (mode === 'camera') {
                updateCanvas();
                animFrame = requestAnimationFrame(loop);
            }
        }
        
        function requestUpdate() {
            // é˜²æ­¢é‡å¤è¯·æ±‚æ›´æ–°å¸§
            if (updatePending || mode !== 'image') return;
            updatePending = true;
            requestAnimationFrame(() => {
                updateCanvas();
                updatePending = false;
            });
        }

        // --- æ ¸å¿ƒç®—æ³•éƒ¨åˆ† ---
        function updateCanvas() {
            if (!sourceEl) return;
            
            // è·å–å°ºå¯¸
            const sw = mode === 'camera' ? sourceEl.videoWidth : sourceEl.naturalWidth;
            const sh = mode === 'camera' ? sourceEl.videoHeight : sourceEl.naturalHeight;
            
            if (!sw || !sh) return;
            
            // åªåœ¨å°ºå¯¸å˜åŒ–æ—¶é‡æ–°è®¾ç½®ç”»å¸ƒå¤§å°ï¼ˆé¿å…æ¯å¸§é‡ç½®å¯¼è‡´çš„æ€§èƒ½æŸè€—ï¼‰
            if (lastCanvasSize.w !== sw || lastCanvasSize.h !== sh) {
                canvas.width = sw;
                canvas.height = sh;
                lastCanvasSize = { w: sw, h: sh };
            }
            
            // ç›´æ¥è¯»å–ç¼“å­˜çš„DOMå…ƒç´ å€¼
            const myopia = parseInt(myopiaRangeEl.value);
            const astigmatism = parseInt(astigmatismRangeEl.value);
            const axis = parseInt(axisRangeEl.value);
            const isSplit = splitViewEl.checked;
            
            // 1. è®¡ç®—ç‰©ç†å‚æ•°
            // è¿‘è§†æ¨¡ç³Šç³»æ•°ï¼šå¢åŠ ç³»æ•°ï¼Œä½¿300åº¦ä¹Ÿèƒ½çœ‹æ¸…æ¨¡ç³Šæ•ˆæœ (0.04 æ˜¯ç»éªŒå€¼)
            const blurRadius = myopia * 0.04; 
            
            // æ•£å…‰åç§»é‡ï¼šè¿™ä¸ªå†³å®šé‡å½±çš„è·ç¦»
            // çœŸå®çš„æ•£å…‰æ˜¯ç‚¹æ‰©æ•£æˆçº¿ï¼Œæˆ‘ä»¬é€šè¿‡å¤šé‡é‡‡æ ·æ¥æ¨¡æ‹Ÿ
            const astigStrength = astigmatism * 0.08; 
            
            // ç»˜åˆ¶èƒŒæ™¯ï¼ˆé»‘è‰²ï¼‰
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, sw, sh);

            // è¾…åŠ©ç»˜å›¾å‡½æ•°ï¼šå¤„ç†å•è¾¹æ¸²æŸ“
            function drawScene(isBlurred) {
                if (!isBlurred) {
                    ctx.filter = 'none';
                    ctx.drawImage(sourceEl, 0, 0, sw, sh);
                    return;
                }

                // æ­¥éª¤A: åº”ç”¨è¿‘è§† (é«˜æ–¯æ¨¡ç³Š)
                // ä½¿ç”¨ filter å±æ€§æ˜¯æœ€å¿«çš„æ–¹æ³•
                // å¦‚æœæ•£å…‰å¾ˆé«˜ï¼Œè¿‘è§†æ¨¡ç³Šåº”è¯¥ç¨å¾®å‡å¼±ä¸€ç‚¹ç‚¹ï¼Œå¦åˆ™å…¨éƒ½ç³Šæˆä¸€å›¢çœ‹ä¸å‡ºé‡å½±
                // ä½†ç‰©ç†ä¸Šå®ƒä»¬æ˜¯å åŠ çš„ã€‚
                ctx.filter = `blur(${blurRadius}px)`;

                // æ­¥éª¤B: åº”ç”¨æ•£å…‰ (æ–¹å‘æ€§é‡å½±)
                if (astigmatism > 0) {
                    // æˆ‘ä»¬ä½¿ç”¨ "Accumulation Buffer" çš„æ€è·¯
                    // åœ¨åŒä¸€ä½ç½®å¤šæ¬¡ç»˜åˆ¶å›¾åƒï¼Œæ¯æ¬¡é€šè¿‡åæ ‡å˜æ¢è¿›è¡Œå¾®å°åç§»
                    // è¿™æ¯”å•çº¯çš„ç¼©æ”¾çœŸå®å¾—å¤š
                    
                    // è‡ªé€‚åº”é‡‡æ ·æ¬¡æ•°ï¼šæ•£å…‰åº¦æ•°è¶Šé«˜ï¼Œéœ€è¦è¶Šå¤šé‡‡æ ·æ¥ä¿æŒå¹³æ»‘
                    // ä½åº¦æ•£å…‰(100åº¦ä»¥ä¸‹)ç”¨5æ¬¡ï¼Œä¸­åº¦(100-300)ç”¨7æ¬¡ï¼Œé«˜åº¦(300+)ç”¨9æ¬¡
                    const passes = astigmatism < 100 ? 5 : (astigmatism < 300 ? 7 : 9);
                    const angleRad = (axis * Math.PI) / 180;
                    
                    // è®¡ç®—è½´å‘çš„å•ä½å‘é‡ (æ•£å…‰è½´å‘é€šå¸¸ä¸æ¨¡ç³Šæ–¹å‘å‚ç›´ï¼Œä½†åœ¨æ¨¡æ‹Ÿå™¨ä¸­ç›´æ¥å¯¹åº”å³å¯)
                    // æ³¨æ„ï¼šåŒ»å­¦æ•£å…‰è½´å‘é€šå¸¸æŒ‡â€œä¸æ¨¡ç³Šâ€çš„é‚£ä¸ªè½´ï¼Œæˆ–è€…â€œæœ€å¹³â€çš„è½´
                    // è¿™é‡Œæˆ‘ä»¬ç®€åŒ–ï¼šè½´å‘å³ä¸ºâ€œæ‹–å½±æ–¹å‘â€
                    const dx = Math.cos(angleRad) * astigStrength;
                    const dy = Math.sin(angleRad) * astigStrength;
                    
                    const alpha = 1 / passes;
                    ctx.globalAlpha = alpha; // é™ä½é€æ˜åº¦è¿›è¡Œå åŠ 
                    
                    // é¢„è®¡ç®—åç§»é‡ä»¥å‡å°‘å¾ªç¯å†…è®¡ç®—
                    const passesMinusOne = Math.max(passes - 1, 1); // é˜²æ­¢é™¤ä»¥é›¶
                    const scale = 10; // æ‰©å¤§åƒç´ å½±å“èŒƒå›´çš„ç³»æ•°
                    
                    // å¾ªç¯ç»˜åˆ¶é‡å½±
                    for (let i = 0; i < passes; i++) {
                        // è®¡ç®—å½“å‰å±‚åç§»: ä» -offset åˆ° +offset åˆ†å¸ƒ
                        const progress = (i / passesMinusOne) - 0.5; // -0.5 åˆ° 0.5
                        const offsetX = dx * progress * scale;
                        const offsetY = dy * progress * scale;
                        
                        ctx.drawImage(sourceEl, offsetX, offsetY, sw, sh);
                    }
                    
                    // æ¢å¤
                    ctx.globalAlpha = 1.0;
                } else {
                    // åªæœ‰è¿‘è§†ï¼Œæ²¡æœ‰æ•£å…‰
                    ctx.drawImage(sourceEl, 0, 0, sw, sh);
                }
                ctx.filter = 'none';
            }

            // åˆ†å±é€»è¾‘
            if (isSplit) {
                const mid = sw / 2;
                
                // å·¦ä¾§ï¼šæ¸…æ™°
                ctx.save();
                ctx.beginPath();
                ctx.rect(0, 0, mid, sh);
                ctx.clip();
                drawScene(false);
                ctx.restore();
                
                // å³ä¾§ï¼šæ¨¡ç³Š
                ctx.save();
                ctx.beginPath();
                ctx.rect(mid, 0, mid, sh);
                ctx.clip();
                // ç¨å¾®å¹³ç§»ä¸€ä¸‹å³ä¾§å†…å®¹çš„ç»˜åˆ¶åŸç‚¹ï¼Œé˜²æ­¢é‡å½±ç”»åˆ°å·¦è¾¹å»ï¼Ÿ
                // å…¶å® clip ä¼šè‡ªåŠ¨å¤„ç†ï¼Œä½†ä¸ºäº†é‡å½±ä¸ç©¿å¸®ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆç”»æ»¡å†åˆ‡ï¼Œæˆ–è€…æ¥å—è¾¹ç•Œæº¢å‡º
                // è¿™é‡Œç›´æ¥ç”»ï¼Œclip ä¼šæˆªæ–­
                drawScene(true);
                ctx.restore();
                
                // åˆ†å‰²çº¿
                ctx.strokeStyle = 'rgba(255,255,255,0.5)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(mid, 0);
                ctx.lineTo(mid, sh);
                ctx.stroke();
                
            } else {
                // å…¨å±æ¨¡å¼
                drawScene(true);
            }
        }
        
        init();
    </script>
</body>
</html>
